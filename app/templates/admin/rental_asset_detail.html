{% extends 'layout.html' %}

{% block title %}Detail Aset Sewa | Admin{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header pb-0 d-flex justify-content-between align-items-center">
                    <h6>Detail Aset Sewa</h6>
                    <div>
                        <a href="{{ url_for('main.admin_rental_assets') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-arrow-left me-2"></i>Kembali
                        </a>
                        <button class="btn btn-primary btn-sm ms-2" onclick="editAsset('{{ asset_id }}')">
                            <i class="fas fa-edit me-2"></i>Edit
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="assetDetailContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Memuat data aset...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Photo Gallery Modal -->
<div class="modal fade" id="photoGalleryModal" tabindex="-1" aria-labelledby="photoGalleryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="photoGalleryModalLabel">Galeri Foto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="photoCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner" id="carouselInner">
                        <!-- Photos will be loaded here -->
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#photoCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#photoCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for asset detail -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load asset details
        loadAssetDetails('{{ asset_id }}');
    });
    
    function loadAssetDetails(id) {
        fetch(`/rental/api/rental-assets/${id}`, {
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        document.getElementById('assetDetailContainer').innerHTML = `
                            <div class="alert alert-warning text-center" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Anda tidak memiliki akses. <a href="/login">Silakan login kembali sebagai admin</a>.
                            </div>
                        `;
                        throw new Error('Unauthorized');
                    }
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(asset => {
                displayAssetDetails(asset);
            })
            .catch(error => {
                console.error('Error fetching asset details:', error);
                if (!error.message.includes('Unauthorized')) {
                    document.getElementById('assetDetailContainer').innerHTML = `
                        <div class="alert alert-danger text-center" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Gagal memuat detail aset. Silakan coba lagi nanti.
                        </div>
                    `;
                }
            });
    }
    
    function displayAssetDetails(asset) {
        const statusBadge = getStatusBadge(asset.status);
        const assetType = asset.type === 'tanah' ? 'Tanah' : 'Bangunan';
        
        let html = `
            <div class="row">
                <div class="col-md-6">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informasi Umum</h6>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <tr>
                                    <th style="width: 30%">Nama Aset</th>
                                    <td>${asset.name}</td>
                                </tr>
                                <tr>
                                    <th>Tipe</th>
                                    <td>${assetType}</td>
                                </tr>
                                <tr>
                                    <th>Status</th>
                                    <td>${statusBadge}</td>
                                </tr>
                                <tr>
                                    <th>Lokasi</th>
                                    <td>${asset.kecamatan || '-'}</td>
                                </tr>
                                <tr>
                                    <th>Alamat</th>
                                    <td>${asset.alamat || '-'}</td>
                                </tr>
                                <tr>
                                    <th>Harga Sewa</th>
                                    <td>Rp ${formatNumber(asset.harga_sewa)}/bulan</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-ruler-combined me-2"></i>Informasi Properti</h6>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <tr>
                                    <th style="width: 30%">Luas Tanah</th>
                                    <td>${asset.luas_tanah} m²</td>
                                </tr>`;
        
        // Add building details if the asset type is building
        if (asset.type === 'bangunan') {
            html += `
                                <tr>
                                    <th>Luas Bangunan</th>
                                    <td>${asset.luas_bangunan || '-'} m²</td>
                                </tr>
                                <tr>
                                    <th>Kamar Tidur</th>
                                    <td>${asset.kamar_tidur || '-'}</td>
                                </tr>
                                <tr>
                                    <th>Kamar Mandi</th>
                                    <td>${asset.kamar_mandi || '-'}</td>
                                </tr>
                                <tr>
                                    <th>Jumlah Lantai</th>
                                    <td>${asset.jumlah_lantai || '-'}</td>
                                </tr>`;
        }
        
        html += `
                                <tr>
                                    <th>Sertifikat</th>
                                    <td>${asset.sertifikat || '-'}</td>
                                </tr>
                                <tr>
                                    <th>Jenis Zona</th>
                                    <td>${asset.jenis_zona || '-'}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-file-alt me-2"></i>Deskripsi</h6>
                        </div>
                        <div class="card-body">
                            ${asset.deskripsi ? asset.deskripsi : '<em>Tidak ada deskripsi</em>'}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-images me-2"></i>Galeri Foto</h6>
                        </div>
                        <div class="card-body">
                            <div class="text-center py-3">
                                <button class="btn btn-primary" onclick="viewGallery()">
                                    <i class="fas fa-image me-2"></i>Lihat Foto
                                </button>
                                <p class="text-muted mt-2"><small>Klik untuk melihat semua foto aset</small></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('assetDetailContainer').innerHTML = html;
    }
    
    function getStatusBadge(status) {
        switch(status) {
            case 'available':
                return '<span class="badge bg-success">Tersedia</span>';
            case 'maintenance':
                return '<span class="badge bg-warning">Dalam Perawatan</span>';
            case 'rented':
                return '<span class="badge bg-info">Disewa</span>';
            default:
                return '<span class="badge bg-secondary">Unknown</span>';
        }
    }
    
    function formatNumber(number) {
        return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    
    function editAsset(id) {
        // Open the edit modal from the rental_assets.html page
        fetch(`/rental/api/rental-assets/${id}`, {
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        alert('Anda tidak memiliki akses. Silakan login kembali sebagai admin.');
                        window.location.href = '/login';
                        throw new Error('Unauthorized');
                    }
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // Redirect back to the main page with the edit modal open
                window.location.href = `/rental/admin-dashboard/sewakan-aset?edit=${id}`;
            })
            .catch(error => {
                console.error('Error fetching asset details:', error);
                if (!error.message.includes('Unauthorized')) {
                    alert('Gagal memuat detail aset');
                }
            });
    }
    
    function viewGallery() {
        // Implementation for viewing the photo gallery
        // This would typically load photos from the API and display them in the modal
        const modal = new bootstrap.Modal(document.getElementById('photoGalleryModal'));
        modal.show();
    }
</script>
{% endblock %}
